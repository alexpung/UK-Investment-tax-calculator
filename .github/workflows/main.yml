# Run workflow on every push to the master branch
on:
  push:
    branches:
      - master
  workflow_dispatch:
  
permissions:
  contents: write
jobs:
  build-project:
  # use ubuntu-latest image to run steps on
    runs-on: windows-latest
    steps:
     - uses: actions/checkout@v2
     - name: Setup .NET Core SDK
       uses: actions/setup-dotnet@v1
       with:
         dotnet-version: 10.0.x
     - name: Install .NET WASM Build Tools
       run: dotnet workload install wasm-tools
     - name: Add Github packages as source
       run: dotnet nuget add source --username alexpung --password ${{ secrets.READPACKAGES }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/alexpung/index.json"
     - name: Build solution
       run: dotnet build --configuration Release
     - name: Run unit tests
       run: dotnet test UnitTest/UnitTest.csproj --collect:"XPlat Code Coverage"
     - name: Install Playwright browsers
       run: pwsh PlaywrightTests/bin/Release/net10.0-windows10.0.22621.0/playwright.ps1 install --with-deps
     - name: Start Blazor app
       run: |
         Start-Process -FilePath "dotnet" -ArgumentList "run", "--project", "`"BlazorApp-Investment Tax Calculator/InvestmentTaxCalculator.csproj`"", "--configuration", "Release", "--urls", "http://localhost:5000" -NoNewWindow
         Start-Sleep -Seconds 30
       shell: pwsh
     - name: Run Playwright tests
       run: dotnet test PlaywrightTests/PlaywrightTests.csproj --configuration Release --no-build
       env:
         BASE_URL: http://localhost:5000
     - name: Upload coverage reports to Codecov
       uses: codecov/codecov-action@v3
       env: 
         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
     - name: Publish .NET Core Project
       run: dotnet publish "BlazorApp-Investment Tax Calculator/InvestmentTaxCalculator.csproj" -c:Release -p:GHPages=true -o dist/Web --nologo
     - name: Patch base href for GitHub Pages
       shell: pwsh
       run: |
         $indexPath = "dist/Web/wwwroot/index.html"
         (Get-Content $indexPath) -replace '<base href=\"/\" />', '<base href=\"/UK-Investment-tax-calculator/\" />' | Set-Content $indexPath
     - name: Deploy
       uses: peaceiris/actions-gh-pages@v3
       with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
         publish_dir: dist/Web/wwwroot
         force_orphan: true
