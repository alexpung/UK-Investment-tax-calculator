@using InvestmentTaxCalculator.Model
@using InvestmentTaxCalculator.Model.TaxEvents
@using InvestmentTaxCalculator.Model.Interfaces
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using InvestmentTaxCalculator.Services

@inject ITradeAndCorporateActionList _taxEventLists
@inject ToastService _toastService

<div class="card mt-4">
    <div class="card-header">
        <h3>Corporate Actions History</h3>
    </div>
    <div class="card-body">
        <SfGrid @ref="_grid" DataSource="@_taxEventLists.CorporateActions" AllowPaging="true" AllowSorting="true">
            <GridPageSettings PageSize="10"></GridPageSettings>
            <GridColumns>
                <GridColumn Field="@nameof(CorporateAction.Date)" HeaderText="Date" Format="d" Width="120"></GridColumn>
                <GridColumn Field="@nameof(CorporateAction.AssetName)" HeaderText="Asset" Width="150"></GridColumn>
                <GridColumn Field="@nameof(CorporateAction.Reason)" HeaderText="Reason/Description"></GridColumn>
                <GridColumn HeaderText="Actions" Width="180" TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var action = (CorporateAction)context;
                            <div class="d-flex gap-2 justify-content-center">
                                <SfButton IconCss="e-icons e-edit" CssClass="e-primary e-small" OnClick="@(() => EditAction(action))" Content="Edit"></SfButton>
                                <SfButton IconCss="e-icons e-delete" CssClass="e-danger e-small" OnClick="@(() => DeleteAction(action))" Content="Delete"></SfButton>
                            </div>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </SfGrid>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnActionDeleted { get; set; }
    [Parameter] public EventCallback<CorporateAction> OnActionEdit { get; set; }
    
    private SfGrid<CorporateAction> _grid = default!;

    public void Refresh()
    {
        _grid?.Refresh();
    }

    private async Task EditAction(CorporateAction action)
    {
        await OnActionEdit.InvokeAsync(action);
    }

    private async Task DeleteAction(CorporateAction action)
    {
        if (_taxEventLists.CorporateActions.Remove(action))
        {
            _toastService.ShowInformation("Corporate action removed.");
            Refresh();
            await OnActionDeleted.InvokeAsync();
        }
    }
}
