@using InvestmentTaxCalculator.Model
@using InvestmentTaxCalculator.Model.TaxEvents
@using InvestmentTaxCalculator.Model.UkTaxModel
@using InvestmentTaxCalculator.Model.Interfaces
@using InvestmentTaxCalculator.Services
@using InvestmentTaxCalculator.Enumerations
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons

@inject UkSection104Pools Section104Pools
@inject TaxEventLists TaxEventLists
@inject ToastService ToastService
@inject CurrencyService CurrencyService

<div class="card bg-secondary text-white">
    <div class="card-header bg-info text-dark">
        <h5 class="mb-0">Add Excess Reportable Income (ERI)</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6 col-lg-4">
                <label class="form-label">Accounting Period End Date</label>
                <SfDatePicker TValue="DateTime?" Value="@PeriodEndDate" ValueChanged="@OnDateChanged" Placeholder="Pick period end date" CssClass="e-outline" Enabled="@(!IsCalculationMissing)"></SfDatePicker>
            </div>

            @if (PeriodEndDate.HasValue)
            {
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Ticker</label>
                    <SfDropDownList TValue="string" TItem="string" DataSource="@AvailableTickers" @bind-Value="@SelectedTicker" Placeholder="Select a ticker" CssClass="e-outline" Enabled="@(!IsCalculationMissing)">
                        <DropDownListEvents TValue="string" TItem="string" ValueChange="OnTickerChanged"></DropDownListEvents>
                    </SfDropDownList>
                </div>

                @if (!string.IsNullOrEmpty(SelectedTicker))
                {
                    <div class="col-md-6 col-lg-4">
                        <label class="form-label">Quantity at Period End</label>
                        <div class="form-control bg-dark text-info border-info">@Quantity.ToString("N4")</div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label class="form-label">Income Type</label>
                        <SfDropDownList TValue="ExcessReportableIncomeType" TItem="EnumDescriptionPair<ExcessReportableIncomeType>" DataSource="@IncomeTypes" @bind-Value="@SelectedIncomeType" CssClass="e-outline">
                            <DropDownListFieldSettings Text="Description" Value="EnumValue"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <label class="form-label">Income Per Share (Local Currency)</label>
                        <SfNumericTextBox TValue="decimal" @bind-Value="@IncomePerShare" Decimals="8" Format="N8" CssClass="e-outline" ShowSpinButton="false" Min="0"></SfNumericTextBox>
                    </div>

                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">Currency</label>
                        <SfDropDownList TValue="string" TItem="CurrencyViewModel" DataSource="@Currencies" @bind-Value="@Currency" CssClass="e-outline">
                            <DropDownListFieldSettings Text="Code" Value="Code"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </div>

                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">Exchange Rate (to GBP)</label>
                        <SfNumericTextBox TValue="decimal" @bind-Value="@FxRate" Decimals="8" Format="N8" CssClass="e-outline" ShowSpinButton="false" Min="0"></SfNumericTextBox>
                    </div>

                    @if (!string.IsNullOrEmpty(GetIsinForTicker(SelectedTicker)))
                    {
                        string isin = GetIsinForTicker(SelectedTicker);
                        <div class="col-md-6 col-lg-4">
                            <label class="form-label">Detected Region (from ISIN: @isin)</label>
                            <div class="form-control bg-dark text-info border-info">
                                @CountryCode.GetRegionByTwoDigitCode(isin[..2]).CountryName (@isin[..2])
                            </div>
                        </div>
                    }

                    <div class="col-12 mt-4 d-flex justify-content-center">
                        <SfButton IsPrimary="true" OnClick="OnSubmit" CssClass="e-info e-large">Add ERI Entry</SfButton>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsCalculationMissing { get; set; }
    [Parameter] public EventCallback OnDataChanged { get; set; }

    private DateTime? PeriodEndDate { get; set; }
    private List<string> AvailableTickers { get; set; } = new();
    private string SelectedTicker { get; set; } = string.Empty;
    private decimal Quantity { get; set; }
    private decimal IncomePerShare { get; set; }
    private string Currency { get; set; } = "GBP";
    private List<CurrencyViewModel> Currencies { get; set; } = new();
    private decimal FxRate { get; set; } = 1.0m;
    private ExcessReportableIncomeType SelectedIncomeType { get; set; } = ExcessReportableIncomeType.DIVIDEND;
    private List<EnumDescriptionPair<ExcessReportableIncomeType>> IncomeTypes { get; set; } = new();

    protected override void OnInitialized()
    {
        IncomeTypes = EnumExtensions.GetEnumDescriptionPair<ExcessReportableIncomeType>(typeof(ExcessReportableIncomeType));
        Currencies = CurrencyService.GetCurrencies();
    }

    private void OnDateChanged(DateTime? date)
    {
        PeriodEndDate = date;
        SelectedTicker = string.Empty;
        AvailableTickers.Clear();
        if (date.HasValue)
        {
            var dateOnly = DateOnly.FromDateTime(date.Value);
            var pools = Section104Pools.GetSection104s();
            foreach (var pool in pools)
            {
                var history = pool.GetLastSection104History(dateOnly);
                if (history != null && history.NewQuantity > 0)
                {
                    if (TaxEventLists.Trades.Any(t => t.AssetName == pool.AssetName && t.AssetType == AssetCategoryType.STOCK))
                    {
                        AvailableTickers.Add(pool.AssetName);
                    }
                }
            }
        }
    }

    private void OnTickerChanged(ChangeEventArgs<string, string> args)
    {
        SelectedTicker = args.Value;
        if (!string.IsNullOrEmpty(SelectedTicker) && PeriodEndDate.HasValue)
        {
            var pool = Section104Pools.GetExistingOrInitialise(SelectedTicker);
            var history = pool.GetLastSection104History(DateOnly.FromDateTime(PeriodEndDate.Value));
            Quantity = history?.NewQuantity ?? 0;
        }
    }

    private string GetIsinForTicker(string ticker)
    {
        var trade = TaxEventLists.Trades.FirstOrDefault(t => t.AssetName == ticker && !string.IsNullOrEmpty(t.Isin));
        if (trade != null) return trade.Isin;

        var dividend = TaxEventLists.Dividends.FirstOrDefault(d => d.AssetName == ticker && !string.IsNullOrEmpty(d.Isin));
        if (dividend != null) return dividend.Isin;

        return string.Empty;
    }

    private async Task OnSubmit()
    {
        if (!PeriodEndDate.HasValue || string.IsNullOrEmpty(SelectedTicker) || IncomePerShare <= 0 || FxRate <= 0)
        {
            ToastService.ShowError("Please fill in all fields correctly.");
            return;
        }

        string isin = GetIsinForTicker(SelectedTicker);
        CountryCode region = string.IsNullOrEmpty(isin) || isin.Length < 2 
            ? CountryCode.UnknownRegion 
            : CountryCode.GetRegionByTwoDigitCode(isin[..2]);

        DateTime distributionDate = PeriodEndDate.Value.AddMonths(6);
        decimal totalAmountLocal = Quantity * IncomePerShare;

        var eri = new ExcessReportableIncome
        {
            AssetName = SelectedTicker,
            Date = distributionDate,
            IncomeType = SelectedIncomeType,
            Amount = new DescribedMoney(totalAmountLocal, Currency, FxRate, $"ERI for {Quantity:N4} shares (Period End: {PeriodEndDate.Value:d})"),
            Isin = isin,
            IncomeLocation = region
        };

        TaxEventLists.CorporateActions.Add(eri);

        if (SelectedIncomeType == ExcessReportableIncomeType.DIVIDEND)
        {
            TaxEventLists.Dividends.Add(new Dividend
            {
                AssetName = SelectedTicker,
                Date = distributionDate,
                DividendType = DividendType.EXCESS_REPORTABLE_INCOME,
                Proceed = new DescribedMoney(totalAmountLocal, Currency, FxRate, $"Excess Reportable Income (Dividend) from {SelectedTicker}"),
                Isin = isin,
                CompanyLocation = region
            });
        }
        else
        {
            TaxEventLists.InterestIncomes.Add(new InterestIncome
            {
                AssetName = SelectedTicker,
                Date = distributionDate,
                InterestType = InterestType.EXCESSREPORTABLEINCOME,
                Amount = new DescribedMoney(totalAmountLocal, Currency, FxRate, $"Excess Reportable Income (Interest) from {SelectedTicker}"),
                Isin = isin,
                IncomeLocation = region
            });
        }

        ToastService.ShowInformation($"Successfully added ERI of {eri.Amount.BaseCurrencyAmount} for {SelectedTicker}.");
        
        SelectedTicker = string.Empty;
        IncomePerShare = 0;

        await OnDataChanged.InvokeAsync();
    }
}
