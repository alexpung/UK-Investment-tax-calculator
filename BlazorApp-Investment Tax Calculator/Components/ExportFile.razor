@using Syncfusion.Blazor.Buttons
@using Microsoft.JSInterop;
@using Services

@inject IJSRuntime JS
@inject DividendExportService dividendExportService
@inject YearOptions years
@inject UkCalculationResultExportService calculationResultExportService
@inject UkSection104ExportService ukSection104ExportService
@inject ExportTaxEventService exportTaxEventService

<div class="card">
    <div class="card-header">
        <h3 class="mb-0">Export Results</h3>
    </div>
    <div class="card-body">
        <p class="text-muted mb-4">Export your calculation results in various formats for record-keeping or further analysis</p>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <SfButton @onclick="InvokeExportDividend" CssClass="btn btn-primary w-100">
                    Export Dividends/Interest Income
                </SfButton>
            </div>
            <div class="col-md-4">
                <SfButton @onclick="InvokeExportTrades" CssClass="btn btn-primary w-100">
                    Export Trades
                </SfButton>
            </div>
            <div class="col-md-4">
                <SfButton @onclick="InvokeExportSection104" CssClass="btn btn-primary w-100">
                    Export Section104
                </SfButton>
            </div>
        </div>

        <div class="alert alert-info alert-custom mb-4" role="alert">
            <h5 class="alert-heading">About Data Export</h5>
            <p class="mb-2">
                The <strong>Export data for future import</strong> button generates a .json file containing all your imported data, 
                manually added trades, ERI/equalisation payments, and other manual corporate action adjustments.
            </p>
            <p class="mb-0">
                Importing this file instead of broker statements in the future will be much faster and preserve all your manual adjustments.
            </p>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <SfButton @onclick="InvokeExportTaxEvents" CssClass="btn btn-success w-100">
                    Export data for future import
                </SfButton>
            </div>
        </div>
    </div>
</div>


@code {
    private IJSObjectReference? _downloadFileJsScript;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _downloadFileJsScript = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/ExportFile.razor.js");
    }

    private async Task InvokeExportDividend()
    {
        string contents = dividendExportService.Export(years.SelectedOptions);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(contents);
        using var streamRef = new DotNetStreamReference(new MemoryStream(file));
        await _downloadFileJsScript!.InvokeVoidAsync("BlazorDownloadFile", "Dividends Summary.txt", streamRef);
    }

    private async Task InvokeExportTrades()
    {
        string contents = calculationResultExportService.PrintToTextFile(years.SelectedOptions);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(contents);
        using var streamRef = new DotNetStreamReference(new MemoryStream(file));
        await _downloadFileJsScript!.InvokeVoidAsync("BlazorDownloadFile", "Trades Calculation.txt", streamRef);
    }

    private async Task InvokeExportSection104()
    {
        string contents = ukSection104ExportService.PrintToTextFile(years.SelectedOptions);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(contents);
        using var streamRef = new DotNetStreamReference(new MemoryStream(file));
        await _downloadFileJsScript!.InvokeVoidAsync("BlazorDownloadFile", "Section104.txt", streamRef);
    }

    private async Task InvokeExportTaxEvents()
    {
        string contents = exportTaxEventService.SerialiseTaxEvents();
        byte[] file = System.Text.Encoding.UTF8.GetBytes(contents);
        using var streamRef = new DotNetStreamReference(new MemoryStream(file));
        await _downloadFileJsScript!.InvokeVoidAsync("BlazorDownloadFile", "data.json", streamRef);
    }
}
