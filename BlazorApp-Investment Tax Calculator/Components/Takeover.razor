@using InvestmentTaxCalculator.Model
@using InvestmentTaxCalculator.Model.TaxEvents
@using InvestmentTaxCalculator.Model.UkTaxModel
@using InvestmentTaxCalculator.Services
@using InvestmentTaxCalculator.Model.Interfaces
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Notifications
@using InvestmentTaxCalculator.Enumerations

@inject UkSection104Pools _ukSection104Pools
@inject TradeCalculationResult _tradeCalculationResult
@inject ITradeAndCorporateActionList _taxEventLists
@inject ToastService _toastService

<div class="card">
    <div class="card-header d-flex justify-content-between align-content-center">
        <h3>@(_isEditing ? "Edit" : "Record") Takeover / Merger</h3>
        @if (_isEditing)
        {
            <SfButton CssClass="e-flat e-small" OnClick="CancelEdit">Cancel Edit</SfButton>
        }
    </div>
    <div class="card-body">
        @if (!_tradeCalculationResult.CalculatedTrade.Any())
        {
            <div class="alert alert-warning">
                Please run a tax calculation first to populate the list of available assets.
            </div>
        }
        else
        {
            <div class="row mb-3">
                <div class="col-md-6 offset-md-6">
                    <label class="form-label">Type</label>
                    <div class="d-flex gap-3">
                         <SfRadioButton Label="Share for Share" Name="takeoverType" Value="ShareForShare" @bind-Checked="@_takeoverType" TChecked="string"></SfRadioButton>
                         <SfRadioButton Label="Share + Cash" Name="takeoverType" Value="SharePlusCash" @bind-Checked="@_takeoverType" TChecked="string"></SfRadioButton>
                    </div>
                </div>
            </div>

            <CorporateActionHeader @bind-Date="@_date"
                                   @bind-SourceTicker="@_oldTicker"
                                   @bind-DestinationTicker="@_newTicker"
                                   @bind-SourceRatio="@_oldSharesRatio"
                                   @bind-DestinationRatio="@_newSharesRatio"
                                   OnInputsChanged="CalculateStats"
                                   SourceLabel="Original Asset (Old Company)"
                                   DestinationLabel="New Company Ticker"
                                   RatioLabel="Exchange Ratio (Old : New)"
                                   SourceUnitLabel="shares of old company"
                                   DestinationUnitLabel="shares of new company">
                <DestinationInfo>
                    Expected New Shares: <strong>@_expectedNewQuantity.ToString("F4")</strong>
                </DestinationInfo>
            </CorporateActionHeader>

            @if (_takeoverType == "SharePlusCash")
            {
                <CashInLieuInput @bind-CashAmount="@_cashAmount"
                                 @bind-CashCurrency="@_cashCurrency"
                                 @bind-CashFx="@_cashFx"
                                 @bind-ElectSmallCash="@_electSmallCash"
                                 Title="Cash Component"
                                 CheckboxHelpText="If cash is less than £3,000 OR less than 5% of total value and this is elected, the cash is not treated as a disposal; it reduces the Section 104 cost basis instead."
                                 CssBackgroundColor="#1e3a8a">
                    <ChildContent>
                        <hr/>
                        <h5>Valuation for Cost Apportionment</h5>
                        <div class="form-text mb-2 text-white-50">Required to calculate the cost basis split between new shares and cash.</div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Total Market Value of New Share Holding</label>
                                <SfNumericTextBox TValue="decimal" @bind-Value="@_newShareMv" Min="0" Placeholder="Amount"></SfNumericTextBox>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Currency</label>
                                <SfDropDownList TValue="string" TItem="CurrencyViewModel" Placeholder="Currency" DataSource="@_currencies" @bind-Value="@_newShareMvCurrency">
                                    <DropDownListFieldSettings Text="Display" Value="Code"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">FX Rate (to GBP)</label>
                                <SfNumericTextBox TValue="decimal" @bind-Value="@_newShareMvFx" Decimals="4" Format="n4" Min="0.000001m"></SfNumericTextBox>
                            </div>
                        </div>
                    </ChildContent>
                </CashInLieuInput>
            }

            <div class="row">
                <div class="col-12">
                    <SfButton IsPrimary="true" OnClick="Submit">@(_isEditing ? "Update" : "Add") Takeover Action</SfButton>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public EventCallback OnCorporateActionAdded { get; set; }
    [Parameter] public TakeoverCorporateAction? ActionToEdit { get; set; }

    private DateTime _date = DateTime.Today;
    private string _takeoverType = "ShareForShare";
    private string? _oldTicker;
    private string? _newTicker;
    private decimal _oldSharesRatio = 1m;
    private decimal _newSharesRatio = 1m;

    private decimal _cashAmount;
    private string _cashCurrency = "GBP";
    private decimal _cashFx = 1m;
    private bool _electSmallCash;

    private decimal _newShareMv;
    private string _newShareMvCurrency = "GBP";
    private decimal _newShareMvFx = 1m;

    private decimal _expectedNewQuantity;
    private bool _isEditing => ActionToEdit != null;

    private List<CurrencyViewModel> _currencies = [];

    protected override void OnInitialized()
    {
        _currencies = CurrencyService.GetCurrencies();
        if (ActionToEdit != null)
        {
            LoadAction(ActionToEdit);
        }
    }

    protected override void OnParametersSet()
    {
        if (ActionToEdit != null)
        {
            LoadAction(ActionToEdit);
        }
    }

    private void LoadAction(TakeoverCorporateAction action)
    {
        _date = action.Date;
        _oldTicker = action.AssetName;
        _newTicker = action.AcquiringCompanyTicker;
        _oldSharesRatio = 1m; 
        _newSharesRatio = action.OldToNewRatio;
        
        if (action.CashComponent != null)
        {
            _takeoverType = "SharePlusCash";
            _cashAmount = action.CashComponent.Amount.Amount;
            _cashCurrency = action.CashComponent.Amount.Currency;
            _cashFx = action.CashComponent.FxRate;
            _electSmallCash = action.ElectTaxDeferral;
        }
        else
        {
            _takeoverType = "ShareForShare";
        }

        if (action.NewSharesMarketValue != null)
        {
             _newShareMv = action.NewSharesMarketValue.Amount.Amount;
             _newShareMvCurrency = action.NewSharesMarketValue.Amount.Currency;
             _newShareMvFx = action.NewSharesMarketValue.FxRate;
        }

        CalculateStats();
    }

    private void CancelEdit()
    {
         _oldTicker = null;
         _newTicker = null;
         ActionToEdit = null;
         OnCorporateActionAdded.InvokeAsync();
    }

    private void CalculateStats()
    {
        _expectedNewQuantity = 0;
        if (_oldSharesRatio > 0 && !string.IsNullOrEmpty(_oldTicker))
        {
            var pool = _ukSection104Pools.GetExistingOrInitialise(_oldTicker!);
            var history = pool.GetLastSection104History(DateOnly.FromDateTime(_date));
            decimal currentHolding = history?.NewQuantity ?? 0;
            _expectedNewQuantity = currentHolding * (_newSharesRatio / _oldSharesRatio);
        }
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(_oldTicker))
        {
            _toastService.ShowError("Please select the original asset.");
            return;
        }
        if (string.IsNullOrWhiteSpace(_newTicker))
        {
            _toastService.ShowError("Please enter the new company ticker.");
            return;
        }
        if (_oldTicker == _newTicker)
        {
             _toastService.ShowError("Old and New tickers cannot be the same.");
             return;
        }
        if (_oldSharesRatio <= 0 || _newSharesRatio <= 0)
        {
            _toastService.ShowError("Ratio values must be greater than zero.");
            return;
        }

        decimal ratio = _newSharesRatio / _oldSharesRatio;

        DescribedMoney? cashComponent = null;
        DescribedMoney? newShareMv = null;

        if (_takeoverType == "SharePlusCash")
        {
            if (_cashAmount <= 0)
            {
                 _toastService.ShowError("Cash amount must be greater than zero.");
                 return;
            }
             if (_newShareMv <= 0)
            {
                 _toastService.ShowError("New share market value must be greater than zero.");
                 return;
            }

            if (_cashFx <= 0 || _newShareMvFx <= 0)
            {
                 _toastService.ShowError("FX rate must be greater than zero.");
                 return;
            }

            cashComponent = new DescribedMoney(_cashAmount, _cashCurrency, _cashFx, "Cash component");
            newShareMv = new DescribedMoney(_newShareMv, _newShareMvCurrency, _newShareMvFx, "New share MV");

            if (_electSmallCash)
            {
                decimal cashInBase = cashComponent.BaseCurrencyAmount.Amount;
                decimal totalValue = cashInBase + newShareMv!.BaseCurrencyAmount.Amount;
                if (!UkTaxRules.IsSmallCash(cashInBase, totalValue))
                {
                     _toastService.ShowError("You elected for Small Cash treatment, but the cash amount exceeds £3,000 and 5% of the total value. This election is invalid.");
                     return;
                }
            }
        }

        var action = new TakeoverCorporateAction
        {
            Date = _date,
            AssetName = _oldTicker,
            AcquiringCompanyTicker = _newTicker,
            OldToNewRatio = ratio,
            CashComponent = cashComponent,
            ElectTaxDeferral = _electSmallCash,
            NewSharesMarketValue = newShareMv
        };

        if (_isEditing)
        {
            _taxEventLists.CorporateActions.Remove(ActionToEdit!);
        }

        _taxEventLists.CorporateActions.Add(action);
        _toastService.ShowInformation(_isEditing ? "Takeover updated successfully." : "Takeover action added successfully.");
        await OnCorporateActionAdded.InvokeAsync();
    }
}
