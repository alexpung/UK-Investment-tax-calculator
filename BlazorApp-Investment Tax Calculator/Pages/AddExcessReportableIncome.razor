@page "/AddExcessReportableIncome"
@using InvestmentTaxCalculator.Model
@using InvestmentTaxCalculator.Model.TaxEvents
@using InvestmentTaxCalculator.Model.UkTaxModel
@using InvestmentTaxCalculator.Model.Interfaces
@using InvestmentTaxCalculator.Services
@using InvestmentTaxCalculator.Enumerations
@using InvestmentTaxCalculator.Components
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Grids

@implements IDisposable
@inject UkSection104Pools Section104Pools
@inject TaxEventLists TaxEventLists
@inject ToastService ToastService
@inject ITaxYear TaxYear
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject TaxCalculationService TaxCalculationService

<div class="bg-dark text-light p-4 position-relative">
    <div class="container-fluid">
        <!-- Page Title -->
        <div class="row mb-5">
            <div class="col text-center">
                <h1 class="display-4">ERI and Fund Equalisation</h1>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info border-info bg-dark text-light shadow-sm" role="alert">
                    <h5 class="alert-heading text-info"><i class="bi bi-info-circle-fill me-2"></i>Guidance & How to Use</h5>
                    <hr class="border-info opacity-25">
                    
                    <div class="mb-3">
                        <h6 class="text-info fw-bold">How to Use:</h6>
                        <ol class="mb-2">
                            <li><strong>Add ERI:</strong> Enter the fund's accounting period end date, ticker, and income per share. This calculates the total ERI based on your holdings at that date.</li>
                            <li><strong>Add Equalisation:</strong> Select the fund ticker and the specific income event (Dividend or ERI) to be reduced by the equalisation amount.</li>
                        </ol>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-info fw-bold">Important Workflow Notes:</h6>
                        <ul class="mb-0">
                            <li><strong>Accumulating Funds:</strong> For accumulating funds with equalisation, you must <strong>add the Excess Reportable Income (ERI) first</strong>. Once added, you can then select that ERI entry in the Equalisation section to reduce it.</li>
                            <li><strong>Ticker Selection:</strong> Some available tickers may be standard stocks (non-funds). Ensure you only apply ERI or Equalisation to appropriate offshore fund assets.</li>
                            <li><strong>Manual Matching:</strong> You are responsible for matching equalisation payments to the correct corresponding income event as per your broker's tax reports.</li>
                            <li><strong>Export & Backup:</strong> All manual entries are saved automatically to the session. You can export the entire session (including ERI and Equalisation) for future use from the <a href="MainCalculatorPage" class="alert-link">Main Import/Export page</a>.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        @if (_isCalculationMissing)
        {
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">Calculations Required</h4>
                <p>No Section 104 pools found. Please run the calculation first in the <a href="MainCalculatorPage" class="alert-link">Import/Export page</a> before adding entries, so that available tickers and quantities can be populated.</p>
            </div>
        }

        <div class="row g-4">
            <div class="col-xl-6">
                <EriControl IsCalculationMissing="@_isCalculationMissing" OnDataChanged="RefreshAll" />
            </div>
            <div class="col-xl-6">
                <EqualisationControl IsCalculationMissing="@_isCalculationMissing" OnDataChanged="RefreshAll" />
            </div>
        </div>

        <!-- Corporate Action History Table -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-3">Corporate Action History (ERI & Equalisation)</h3>
                <SfGrid TValue="CorporateAction" DataSource="@History" AllowPaging="true">
                    <GridPageSettings PageSize="10"></GridPageSettings>
                    <GridColumns>
                        <GridColumn Field="@nameof(CorporateAction.AssetName)" HeaderText="Ticker" Width="120"></GridColumn>
                        <GridColumn Field="@nameof(CorporateAction.Date)" HeaderText="Date" Format="d" Type="ColumnType.Date" Width="150"></GridColumn>
                        <GridColumn HeaderText="Type" Width="150">
                            <Template>
                                @{
                                    var ca = context as CorporateAction;
                                    if (ca is ExcessReportableIncome eri)
                                    {
                                        <span>ERI (@eri.IncomeType.GetDescription())</span>
                                    }
                                    else if (ca is FundEqualisation)
                                    {
                                        <span>Equalisation</span>
                                    }
                                    else
                                    {
                                        <span>@ca?.GetType().Name</span>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Amount (Local)" Width="150">
                            <Template>
                                @{
                                    var ca = context as CorporateAction;
                                    if (ca is ExcessReportableIncome eri)
                                    {
                                        <span>@eri.Amount.Amount.ToString()</span>
                                    }
                                    else if (ca is FundEqualisation fe)
                                    {
                                        <span>@fe.Amount.Amount.ToString()</span>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Amount (GBP)" Width="150">
                            <Template>
                                @{
                                    var ca = context as CorporateAction;
                                    if (ca is ExcessReportableIncome eri)
                                    {
                                        <span>@eri.Amount.BaseCurrencyAmount.Amount.ToString("N2")</span>
                                    }
                                    else if (ca is FundEqualisation fe)
                                    {
                                        <span>@fe.Amount.BaseCurrencyAmount.Amount.ToString("N2")</span>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(CorporateAction.Reason)" HeaderText="Details"></GridColumn>
                    </GridColumns>
                </SfGrid>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control-plaintext {
        font-weight: bold;
        color: #17a2b8;
    }
</style>

@code {
    private List<CorporateAction> History { get; set; } = new();
    
    private bool _isCalculationMissing = false;
    private bool _dataChanged = false;
    private IDisposable? _registration;

    protected override void OnInitialized()
    {
        _isCalculationMissing = !Section104Pools.GetSection104s().Any();
        RefreshHistory();

        _registration = NavigationManager.RegisterLocationChangingHandler(OnLocationChanging);
    }

    private void RefreshHistory()
    {
        History = TaxEventLists.CorporateActions
            .Where(e => e is ExcessReportableIncome or FundEqualisation)
            .OrderByDescending(e => e.Date)
            .ToList();
        StateHasChanged();
    }

    private void RefreshAll()
    {
        _dataChanged = true;
        RefreshHistory();
    }

    private async ValueTask OnLocationChanging(LocationChangingContext context)
    {
        if (_dataChanged)
        {
            _dataChanged = false;
            await TaxCalculationService.CalculateAsync();
        }
    }

    public void Dispose()
    {
        _registration?.Dispose();
    }
}
