@page "/corporate-actions"

@using InvestmentTaxCalculator.Components
@using InvestmentTaxCalculator.Model.TaxEvents
@using StockSplitAction = InvestmentTaxCalculator.Model.TaxEvents.StockSplit
@using InvestmentTaxCalculator.Services
@using Syncfusion.Blazor.DropDowns
@implements IDisposable
@inject TaxCalculationService _taxCalculationService
@inject NavigationManager _navigationManager

<div class="container-fluid py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Page Header -->
            <div class="page-header text-center mb-5">
                <h1 class="page-title">Corporate Actions and User Events</h1>
                <p class="page-subtitle">Select an action/event type to configure and record entries</p>
            </div>

            <!-- Action Selector -->
            <div class="row mb-5 justify-content-center">
                <div class="col-md-5">
                    <div class="card bg-dark border-secondary shadow-sm">
                        <div class="card-body">
                            <label class="form-label text-info fw-bold">Select Action/Event Type</label>
                            <SfDropDownList TValue="string" TItem="string" DataSource="@_actionTypes" @bind-Value="@_selectedAction" Placeholder="Choose an action/event type">
                                <DropDownListEvents TValue="string" TItem="string" ValueChange="@OnActionTypeChanged" />
                            </SfDropDownList>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conditional UI based on selection -->
            <div class="section mb-5">
                @if (_selectedAction == "Takeover / Merger")
                {
                    <Takeover OnCorporateActionAdded="OnActionModified" ActionToEdit="@(_actionToEdit as TakeoverCorporateAction)" />
                }
                else if (_selectedAction == "Spinoff")
                {
                    <Spinoff OnCorporateActionAdded="OnActionModified" ActionToEdit="@(_actionToEdit as SpinoffCorporateAction)" />
                }
                else if (_selectedAction == "Stock Split / Reverse Split")
                {
                    <StockSplit OnCorporateActionAdded="OnActionModified" ActionToEdit="@(_actionToEdit as StockSplitAction)" />
                }
                else if (_selectedAction == "Gift to partner")
                {
                    <PartnerTransfer Direction="PartnerTransferDirection.GiftToPartner"
                                     OnCorporateActionAdded="OnActionModified"
                                     ActionToEdit="GetPartnerActionToEdit(PartnerTransferDirection.GiftToPartner)" />
                }
                else if (_selectedAction == "Receive from partner")
                {
                    <PartnerTransfer Direction="PartnerTransferDirection.ReceiveFromPartner"
                                     OnCorporateActionAdded="OnActionModified"
                                     ActionToEdit="GetPartnerActionToEdit(PartnerTransferDirection.ReceiveFromPartner)" />
                }
            </div>

            <!-- Corporate Actions and Events History Section -->
            <div class="section">
                <CorporateActionsList @ref="_historyList" OnActionDeleted="OnActionModified" OnActionEdit="HandleEdit" />
            </div>
        </div>
    </div>
</div>

@code {
    private CorporateActionsList? _historyList;
    private bool _hasChanges = false;
    private IDisposable? _navigationRegistration;
    
    private List<string> _actionTypes = new() { "Takeover / Merger", "Spinoff", "Stock Split / Reverse Split", "Gift to partner", "Receive from partner" };
    private string? _selectedAction = "Takeover / Merger";

    private CorporateAction? _actionToEdit;

    protected override void OnInitialized()
    {
        _navigationRegistration = _navigationManager.RegisterLocationChangingHandler(OnLocationChanging);
    }

    private void OnActionTypeChanged(Syncfusion.Blazor.DropDowns.ChangeEventArgs<string, string> args)
    {
        if (args.IsInteracted)
        {
            _actionToEdit = null; 
        }
    }

    private void HandleEdit(CorporateAction action)
    {
        _actionToEdit = action;
        
        if (action is TakeoverCorporateAction) _selectedAction = "Takeover / Merger";
        else if (action is SpinoffCorporateAction) _selectedAction = "Spinoff";
        else if (action is StockSplitAction) _selectedAction = "Stock Split / Reverse Split";
        else if (action is PartnerTransferCorporateAction partner && partner.Direction == PartnerTransferDirection.GiftToPartner) _selectedAction = "Gift to partner";
        else if (action is PartnerTransferCorporateAction partner2 && partner2.Direction == PartnerTransferDirection.ReceiveFromPartner) _selectedAction = "Receive from partner";
        
        StateHasChanged();
    }

    private PartnerTransferCorporateAction? GetPartnerActionToEdit(PartnerTransferDirection direction)
    {
        PartnerTransferCorporateAction? action = _actionToEdit as PartnerTransferCorporateAction;
        if (action?.Direction != direction) return null;
        return action;
    }

    private void OnActionModified()
    {
        _hasChanges = true;
        _actionToEdit = null; 
        _historyList?.Refresh();
        StateHasChanged();
    }

    private async ValueTask OnLocationChanging(LocationChangingContext _)
    {
        if (_hasChanges)
        {
            _hasChanges = false;
            await _taxCalculationService.CalculateAsync(CalculationTrigger.NavigationRefresh);
        }
    }

    public void Dispose()
    {
        _navigationRegistration?.Dispose();
    }
}

